<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/modern-screenshot@4.6.6/dist/index.min.js"></script>
  </head>
  <body style="margin: 0">
    <iframe frameborder="0" style="width: 100%; height: 100vh"></iframe>

    <script>
      const MESSAGE_ORIGIN = "http://localhost:5173";
      const iframe = document.querySelector("iframe");

      iframe.style.height =
        new URLSearchParams(location.search).get("height") || "100vh";

      const respond = (source, origin, type, payload) =>
        source.postMessage({ type, payload }, origin);

      window.addEventListener("message", ({ origin, data, source }) => {
        if (origin !== MESSAGE_ORIGIN) {
          return;
        }

        const { type, payload } = data;

        if (type === "render") {
          try {
            const { html, css, js } = payload;
            iframe.srcdoc = `<!DOCTYPE html>
                              <html>
                                <head>
                                  <style>${css}</style>
                                </head>
                                <body>
                                  ${html}
                                  <script>${js}<\/script>
                                </body>
                              </html>`;

            respond(source, origin, "render:response", {
              status: "success",
              message: "Rendered",
            });
          } catch (err) {
            respond(source, origin, "render:response", {
              status: "error",
              message: err.message || "Render failed",
            });
          }
        }

        if (type === "screenshot") {
          modernScreenshot
            .domToJpeg(iframe.contentDocument.body, {
              height: iframe.offsetHeight,
            })
            .then((dataUrl) =>
              respond(source, origin, "screenshot:response", {
                status: "success",
                dataUrl,
              }),
            )
            .catch((err) =>
              respond(source, origin, "screenshot:response", {
                status: "error",
                message: err.message || "Screenshot failed",
              }),
            );
        }
      });
    </script>
  </body>
</html>
